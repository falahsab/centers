<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø£ÙˆØ±Ø§Ù‚ Google Sheet</title>
  <style>
    body { font-family: "Tajawal", sans-serif; background:#f7f7f8; padding:20px; text-align:center; }
    input { width:90%; max-width:420px; padding:10px; font-size:18px; border-radius:8px; border:1px solid #ccc; }
    .student{ background:#fff; border:1px solid #e1e1e1; padding:10px; margin:10px auto; max-width:420px; text-align:right; border-radius:8px;}
    .status{ margin:10px 0; color:#555; }
    button{ margin-top:8px; padding:8px 12px; border-radius:8px; border:none; background:#007bff; color:#fff; cursor:pointer;}
  </style>
</head>
<body>
  <h2>ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø£ÙˆØ±Ø§Ù‚ Google Sheet</h2>
  <div class="status" id="status">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  <input id="searchName" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„..." disabled>
  <div><button onclick="clearSearch()">Ù…Ø³Ø­</button></div>
  <div id="result" style="display:none;"></div>

<script>
(async function(){
  // ======== Ø¹Ø¯Ù‘Ù„ ÙÙ‚Ø· Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù ========
  const sheetId = "1QrQejijDXc_8WzzMVi7IvrWOuGpxXjLkUlleTGuj1NM";
  // =====================================
  const statusEl = document.getElementById('status');
  const searchInput = document.getElementById('searchName');
  let students = [];

  function setStatus(t){ statusEl.textContent = t; }

  // 1) Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ - Ù†Ø¬Ø±Ø¨ feeds JSON (ÙŠØ¯Ø¹Ù… Ø§Ù„Ø´ÙŠØª Ø§Ù„Ø¹Ø§Ù…)
  async function fetchSheetList(sid){
    const url = `https://spreadsheets.google.com/feeds/worksheets/${sid}/public/basic?alt=json`;
    try{
      const r = await fetch(url);
      if(!r.ok) throw new Error('fail-list');
      const j = await r.json();
      const entries = j.feed.entry || [];
      return entries.map(e => ({ title: e.title.$t }));
    }catch(err){
      console.warn('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ù…Ù† feeds JSON:', err);
      return null;
    }
  }

  // 2) ØªØ­Ù…ÙŠÙ„ CSV Ù„ÙˆØ±Ù‚Ø© Ø§Ø³Ù…Ù‡Ø§ sheetName
  async function fetchSheetCSV(sid, sheetName){
    const csvUrl = `https://docs.google.com/spreadsheets/d/${sid}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
    const r = await fetch(csvUrl);
    if(!r.ok) throw new Error('fetch-csv-fail');
    return r.text();
  }

  // 3) parse CSV -> array of objects
  function parseCSV(text){
    text = text.trim();
    if(!text) return [];
    const lines = text.split(/\r?\n/).filter(l=>l.trim()!=='');
    if(lines.length < 1) return [];
    const headers = lines[0].split(',').map(h=>h.trim());
    const data = [];
    for(let i=1;i<lines.length;i++){
      // handle commas inside quotes naively by splitting only on commas not inside quotes would be better,
      // but keep it simple â€” if your data may contain commas, tell me ÙˆØ³Ø£Ø­Ø³Ù† parsing.
      const values = lines[i].split(',');
      const obj = {};
      headers.forEach((h,j)=> obj[h] = (values[j] || "").trim());
      data.push(obj);
    }
    return data;
  }

  // 4) Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹ (Ø£Ùˆ ÙˆØ±Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ùˆ ÙØ´Ù„)
  setStatus('Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚...');
  let sheetList = await fetchSheetList(sheetId);

  if(!sheetList || sheetList.length===0){
    // Ø¥Ø°Ø§ ÙØ´Ù„Ù†Ø§ØŒ Ù†Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© "Sheet1" Ø«Ù… "Sheet 1" Ø«Ù… Ø§Ø³Ù… Ø£ÙˆÙ„ gid
    setStatus('Ù„Ù… Ù†Ø³ØªØ·Ø¹ Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ Ø³Ù†Ø¬Ø±Ø¨ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Sheet1...');
    const tryNames = ['Sheet1','Sheet 1','sheet1'];
    let loadedAny = false;
    for(const n of tryNames){
      try{
        const txt = await fetchSheetCSV(sheetId, n);
        const rows = parseCSV(txt);
        students = students.concat(rows);
        setStatus(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ÙˆØ±Ù‚Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: ${n} â€” ${rows.length} ØµÙ`);
        loadedAny = true;
        break;
      }catch(e){
        console.warn('try fallback', n, e);
      }
    }
    if(!loadedAny){
      setStatus('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø´ÙŠØª: (1) Ø¹Ø§Ù… Ù„Ù„Ø¹Ø±Ø¶ Ùˆ(2) ØªØ¹Ù…Ù„ Ù…Ù† Ø®Ø§Ø¯Ù… HTTP ÙˆÙ„ÙŠØ³ file://');
    }
  } else {
    setStatus(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${sheetList.length} ÙˆØ±Ù‚Ø©. Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„Ù‡Ø§...`);
    // ØªØ­Ù…ÙŠÙ„ Ù…ØªÙˆØ§Ø²ÙŠ Ù„ÙƒÙ„ ÙˆØ±Ù‚Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise.allSettled
    const promises = sheetList.map(s => fetchSheetCSV(sheetId, s.title)
      .then(txt => ({name: s.title, rows: parseCSV(txt)}))
      .catch(err => ({name: s.title, error: err}))
    );
    const results = await Promise.all(promises);
    let total = 0, failed = 0;
    for(const r of results){
      if(r.error){ failed++; console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ÙˆØ±Ù‚Ø©', r.name, r.error); continue; }
      students = students.concat(r.rows.map(row => ({...row, __sheetName: r.name})));
      total += r.rows.length;
    }
    setStatus(`Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${total} ØµÙ Ù…Ù† ${sheetList.length} ÙˆØ±Ù‚Ø©${failed?` â€” ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ${failed} ÙˆØ±Ù‚Ø©`:"" : ""}`);
  }

  // Ø§Ù„Ø¢Ù† Ø¬Ù‡Ù‘Ø² Ø§Ù„Ø¨Ø­Ø«
  if(students.length>0){
    searchInput.disabled = false;
    searchInput.focus();
  } else {
    setStatus('Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ ØµÙÙˆÙ. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ÙˆØ±Ù‚Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: name,num,deger,mob ÙˆØ£Ù† Ø§Ù„Ø´ÙŠØª Ø¹Ø§Ù… Ù„Ù„Ø¹Ø±Ø¶.');
  }

  // Ø§Ù„Ø¨Ø­Ø« Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© â€” Ù†Ù†ØªØ¸Ø± Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø§Ù‡Ø²Ø©
  searchInput.addEventListener('input', function(){
    const keyword = this.value.trim().toLowerCase();
    const res = document.getElementById('result');
    if(keyword === ""){
      res.style.display = 'none';
      return;
    }
    const matches = students.filter(s =>
      (s.name && s.name.toLowerCase().includes(keyword)) ||
      (s.mob && s.mob.includes(keyword))
    );
    res.style.display = 'block';
    showResults(matches);
  });

  function showResults(list){
    const res = document.getElementById('result');
    if(list.length === 0){
      res.innerHTML = '<div class="status">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>';
      return;
    }
    res.innerHTML = list.map(s => `
      <div class="student">
        <div style="font-weight:700;color:#007bff">ğŸ‘¤ ${s.name || ''}</div>
        <div>ğŸ“± ${s.mob || ''}</div>
        <div>ğŸ”¢ ${s.num || ''}</div>
        <div>ğŸ’° ${s.deger || ''}</div>
        ${s.__sheetName? `<div style="font-size:12px;color:#666;margin-top:6px;">Ø§Ù„ÙˆØ±Ù‚Ø©: ${s.__sheetName}</div>` : ''}
      </div>
    `).join('');
  }

  // Ø²Ø± Ù…Ø³Ø­
  window.clearSearch = function(){
    searchInput.value = '';
    document.getElementById('result').style.display = 'none';
  };

})();
</script>
</body>
</html>
