<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø§Ù…ÙŠÙ… - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
<style>
body { font-family: "Tajawal", sans-serif; background: #f3f4f6; color: #1e293b; padding: 15px; margin: 0; }
.container { max-width: 700px; margin: auto; background: #ffffff; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 20px; }
h2 { text-align: center; color: #0ea5e9; margin-bottom: 20px; }
input, textarea, button, select { width: 100%; margin: 6px 0; padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; font-size: 16px; box-sizing: border-box; transition: all 0.2s ease; }
input:focus, textarea:focus, select:focus { border-color: #0ea5e9; box-shadow: 0 0 6px rgba(14,165,233,0.3); outline: none; }
textarea { resize: none; white-space: pre-wrap; }
button { background: #06b6d4; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.2s, transform 0.1s; border: none; }
button:hover { background: #0ea5e9; transform: translateY(-1px); }
button:disabled { opacity: 0.6; cursor: not-allowed; }
.memo { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin: 12px 0; position: relative; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: all 0.2s ease; }
.memo:hover { transform: scale(1.01); box-shadow:0 4px 10px rgba(0,0,0,0.08); }
.memo span.city { position:absolute; left:12px; top:12px; font-weight:bold; color:#10b981; }
.memo .actions button { width:auto; padding:6px 12px; margin-left:5px; border-radius:8px; font-size:14px; background:#f1f5f9; color:#0f172a; border:1px solid #cbd5e1; }
.memo .actions button:hover { background:#e2e8f0; }
.memo .title { font-size:17px; font-weight:bold; margin-bottom:6px; }
.memo .content { white-space: pre-line; margin-bottom:5px; color:#334155; }
hr { width:100%; border:none; border-top:1px solid #e2e8f0; margin:20px 0; }
@media (max-width:480px) { input, textarea, button, select { font-size:14px; padding:10px; } .memo { padding:10px; } .memo .actions button { font-size:12px; padding:5px 8px; } }
.success-msg { background:#d1fae5; color:#065f46; padding:10px; border-radius:8px; margin-bottom:10px; display:none; }
#newMemoForm { display:none; margin-bottom:10px; }
</style>
</head>
<body>
<div class="container">
  <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø§Ù…ÙŠÙ…</h2>

  <div class="success-msg" id="msg"></div>

  <button id="showAddBtn">â• Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù…ÙŠÙ… Ø¬Ø¯ÙŠØ¯</button>

  <div id="newMemoForm">
    <input type="text" id="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ¹Ù…ÙŠÙ…">
    <input type="text" id="city" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©">
    <textarea id="content" rows="4" placeholder="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù…ÙŠÙ…"></textarea>
    <button id="addBtn">ğŸ“¤ Ù†Ø´Ø± Ø§Ù„ØªØ¹Ù…ÙŠÙ…</button>
    <button id="cancelAdd" style="background:#f87171; margin-top:5px;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
  </div>

  <hr>

  <select id="cityFilter">
    <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</option>
  </select>

  <div id="memos"></div>
</div>

<script>
const SCRIPT_ID = "AKfycbyNpX3ItLXn_U2uiMKrmZk983VjIj0SqHi337d79KCujF85wzpwDQKBz65_qxi26-0";
const API_URL = `https://script.google.com/macros/s/${SCRIPT_ID}/exec`;
const $ = s => document.querySelector(s);
let allMemos=[];
const titleColors = ['#0ea5e9','#06b6d4','#10b981','#3b82f6','#f59e0b','#a855f7'];

function showMsg(text){ const el=$('#msg'); el.innerText=text; el.style.display='block'; setTimeout(()=>el.style.display='none',2000); }

async function fetchMemos(){
  try{
    const res = await fetch(API_URL);
    const memos = await res.json();
    allMemos = memos.filter(m=>m.Status!=='Deleted');
    populateCities();
    renderMemos($('#cityFilter').value);
  } catch(err){ console.error(err); $('#memos').innerHTML=`<p>âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ØªØ¹Ø§Ù…ÙŠÙ…</p>`; }
}

function renderMemos(city){
  const container=$('#memos'); container.innerHTML='';
  const memosToShow=city==='all'?allMemos:allMemos.filter(m=>m.City===city);

  memosToShow.forEach((m,i)=>{
    const color=titleColors[i%titleColors.length];
    const memoDiv=document.createElement('div'); memoDiv.className='memo'; memoDiv.id=`memo-${m.ID}`;
    memoDiv.innerHTML=`
      <span class="city">${m.City}</span>
      <div class="title" style="color:${color}">${m.Title}</div>
      <div style="color:#64748b;margin-bottom:5px;">ğŸ“… ${m.Date}</div>
      <div class="content">${m.Content}</div>
      <div class="actions" style="margin-top:8px;">
        <button class="editBtn">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="deleteBtn">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    `;

    const editBtn = memoDiv.querySelector('.editBtn');
    const deleteBtn = memoDiv.querySelector('.deleteBtn');

    function setupEdit(){
      if(memoDiv.dataset.editing==='true') return;
      memoDiv.dataset.editing='true';
      const titleDiv = memoDiv.querySelector('.title');
      const contentDiv = memoDiv.querySelector('.content');
      const citySpan = memoDiv.querySelector('.city');

      const titleInput = document.createElement('input'); titleInput.value=m.Title;
      const cityInput = document.createElement('input'); cityInput.value=m.City;
      const contentTextarea = document.createElement('textarea'); contentTextarea.value=m.Content;
      contentTextarea.style.width='100%';
      contentTextarea.style.minHeight='80px';
      contentTextarea.style.whiteSpace='pre-wrap';
      contentTextarea.style.resize='vertical';
      contentTextarea.addEventListener('input', ()=>{ contentTextarea.style.height='auto'; contentTextarea.style.height=contentTextarea.scrollHeight+'px'; });
      contentTextarea.style.height=contentTextarea.scrollHeight+'px';

      titleDiv.replaceWith(titleInput);
      citySpan.replaceWith(cityInput);
      contentDiv.replaceWith(contentTextarea);

      editBtn.innerText='ğŸ’¾ Ø­ÙØ¸';
      const cancelBtn=document.createElement('button'); cancelBtn.innerText='âŒ Ø¥Ù„ØºØ§Ø¡';
      cancelBtn.style.marginLeft='5px'; editBtn.after(cancelBtn);

      editBtn.onclick = async ()=>{
        const updatedTitle = titleInput.value.trim();
        const updatedCity = cityInput.value.trim();
        const updatedContent = contentTextarea.value.trim();
        if(!updatedTitle||!updatedCity||!updatedContent){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; }
        const date = new Date().toLocaleDateString();
        await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'edit',ID:m.ID,Title:updatedTitle,City:updatedCity,Content:updatedContent,Date:date})});
        m.Title=updatedTitle; m.City=updatedCity; m.Content=updatedContent; m.Date=date;
        titleInput.replaceWith(createDiv('title',updatedTitle,color));
        cityInput.replaceWith(createSpan('city',updatedCity));
        contentTextarea.replaceWith(createDiv('content',updatedContent,'#334155'));
        editBtn.innerText='âœï¸ ØªØ¹Ø¯ÙŠÙ„'; cancelBtn.remove(); memoDiv.dataset.editing='false';
        showMsg('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­'); populateCities();
        editBtn.onclick = setupEdit;
      };

      cancelBtn.onclick = ()=>{
        titleInput.replaceWith(createDiv('title',m.Title,color));
        cityInput.replaceWith(createSpan('city',m.City));
        contentTextarea.replaceWith(createDiv('content',m.Content,'#334155'));
        editBtn.innerText='âœï¸ ØªØ¹Ø¯ÙŠÙ„'; cancelBtn.remove(); memoDiv.dataset.editing='false';
        editBtn.onclick = setupEdit;
      };
    }

    editBtn.onclick = setupEdit;

    deleteBtn.onclick=async()=>{
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù…ÙŠÙ…ØŸ')){
        await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'delete',ID:m.ID})});
        memoDiv.remove(); allMemos=allMemos.filter(item=>item.ID!==m.ID); populateCities();
        showMsg('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ¹Ù…ÙŠÙ…');
      }
    };

    container.appendChild(memoDiv);
  });
}

function createDiv(className,text,color=null){ const div=document.createElement('div'); div.className=className; div.textContent=text; if(color) div.style.color=color; return div; }
function createSpan(className,text){ const span=document.createElement('span'); span.className=className; span.textContent=text; return span; }

function populateCities(){
  const select=$('#cityFilter');
  select.querySelectorAll('option:not([value="all"])').forEach(o=>o.remove());
  const cities=[...new Set(allMemos.map(m=>m.City))];
  cities.forEach(c=>{ const option=document.createElement('option'); option.value=c; option.textContent=c; select.appendChild(option); });
}

$('#cityFilter').addEventListener('change',e=>renderMemos(e.target.value));

const showAddBtn = $('#showAddBtn');
const newMemoForm = $('#newMemoForm');
const addBtn = $('#addBtn');
const cancelAdd = $('#cancelAdd');

showAddBtn.onclick = ()=>{
  showAddBtn.style.display='none';
  newMemoForm.style.display='block';
};

cancelAdd.onclick = ()=>{
  newMemoForm.style.display='none';
  showAddBtn.style.display='block';
  $('#title').value=''; $('#city').value=''; $('#content').value='';
};

addBtn.onclick = async ()=>{
  const title = $('#title').value.trim();
  const city = $('#city').value.trim();
  const content = $('#content').value.trim();
  if(!title||!city||!content){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; }
  const date = new Date().toLocaleDateString();
  const ID = Date.now();
  addBtn.disabled=true; addBtn.innerText='â³ Ø¬Ø§Ø±ÙŠ Ù†Ø´Ø± Ø§Ù„ØªØ¹Ù…ÙŠÙ…...';
  await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'add',ID,Title:title,City:city,Content:content,Date:date})});
  $('#title').value=''; $('#city').value=''; $('#content').value='';
  addBtn.disabled=false; addBtn.innerText='ğŸ“¤ Ù†Ø´Ø± Ø§Ù„ØªØ¹Ù…ÙŠÙ…';
  newMemoForm.style.display='none'; showAddBtn.style.display='block';
  fetchMemos(); showMsg('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­');
};

fetchMemos();
</script>
</body>
</html>
