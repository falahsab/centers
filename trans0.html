<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>البحث في جميع أوراق Google Sheets</title>
<style>
body { font-family: "Tajawal", sans-serif; background:#f7f8fa; text-align:center; padding:20px; }
input { width:90%; max-width:400px; padding:10px; font-size:18px; border:1px solid #ccc; border-radius:8px; margin-bottom:15px; }
.result { background:#fff; border:1px solid #ddd; border-radius:10px; margin:10px auto; padding:10px; max-width:400px; text-align:right; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.name { font-weight:bold; color:#007bff; }
.sheet-label { font-size:13px; color:#555; margin-bottom:4px; }
</style>
</head>
<body>

<h2>🔍 البحث في كل أوراق Google Sheet</h2>
<input type="text" id="search" placeholder="اكتب الاسم أو رقم الجوال...">
<div id="output">⏳ جارٍ تحميل البيانات...</div>

<script>
const sheetId = "1QrQejijDXc_8WzzMVi7IvrWOuGpxXjLkUlleTGuj1NM";
let rows = [];

// 1️⃣ نحصل على قائمة الأوراق داخل الشيت
fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`)
  .then(res => res.text())
  .then(txt => {
    // استخراج أسماء الأوراق من النص
    const matches = [...txt.matchAll(/"table":{"cols":.*?,"parsedNumHeaders":\d+},"status":"ok"}],"version":".*?","sig":".*?","reqId":"\d+","table":{"cols":/g)];
    // هذه الطريقة معقدة قليلًا لأن Google لا يوفر API مباشر بدون مفتاح
    // لذا سنستخدم نهج أبسط (مبني على التخمين اليدوي إن عرفت أسماء الأوراق)
    // ✳️ بدلاً من هذا: ضع أسماء الأوراق هنا يدويًا إذا لم تظهر تلقائيًا:
    const sheetNames = ["Sheet1", "Sheet2", "Sheet3"]; // ← غيّرها حسب أوراقك
    
    Promise.all(sheetNames.map(name => loadSheet(sheetId, name)))
      .then(() => {
        document.getElementById("output").innerHTML = `✅ تم تحميل ${rows.length} صف من ${sheetNames.length} أوراق`;
      })
      .catch(err => {
        document.getElementById("output").innerHTML = "⚠️ خطأ أثناء التحميل: " + err;
      });
  });

// 2️⃣ تحميل بيانات ورقة بصيغة CSV
function loadSheet(sheetId, sheetName) {
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  return fetch(url)
    .then(res => res.text())
    .then(csv => {
      const lines = csv.trim().split(/\r?\n/);
      const headers = lines[0].replace(/"/g,"").split(",");
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].replace(/"/g,"").split(",");
        const obj = {};
        headers.forEach((h, j) => obj[h] = values[j]);
        obj.sheet = sheetName; // نضيف اسم الورقة
        rows.push(obj);
      }
    });
}

// 3️⃣ البحث أثناء الكتابة
document.getElementById("search").addEventListener("input", function() {
  const k = this.value.trim().toLowerCase();
  const out = document.getElementById("output");

  if (k === "") { out.innerHTML = ""; return; }

  const matches = rows.filter(r => 
    (r.name && r.name.toLowerCase().includes(k)) ||
    (r.mob && r.mob.includes(k))
  );

  if (matches.length > 0) {
    out.innerHTML = matches.map(s => `
      <div class="result">
        <div class="sheet-label">📄 من الورقة: ${s.sheet}</div>
        <div class="name">👤 الاسم: ${s.name}</div>
        <div>📱 الجوال: ${s.mob}</div>
        <div>🔢 رقم الحوالة: ${s.num}</div>
        <div>💰 المبلغ: ${s.deger}</div>
      </div>
    `).join("");
  } else {
    out.innerHTML = "❌ لا توجد نتائج مطابقة";
  }
});
</script>
</body>
</html>
